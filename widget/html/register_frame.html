<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"/>
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
        .aui-padded-15 div {
            color: #fff;
            margin-bottom: 10px;
        }
        #noavatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            margin: 10px auto;
        }
        .aui-list .aui-list-item-label, .aui-list .aui-list-item-label-icon {
            width: 15%;
        }
    </style>
</head>
<body>
<div class="aui-content" style="background: #fff;">
    <ul class="aui-list aui-form-list">
        <li class="aui-list-item" style="border-bottom: 1px solid #ccc;">
            <img src="../image/noavatar.gif" alt="" id="noavatar" onclick="fnGetPiture()">
        </li>
        <li class="aui-list-item" style="border-bottom: 1px solid #ccc;">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    邮箱
                </div>
                <div class="aui-list-item-input">
                    <input type="text" placeholder="邮箱">
                </div>
            </div>
        </li>

        <li class="aui-list-item" style="border-bottom: 1px solid #ccc;">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    昵称
                </div>
                <div class="aui-list-item-input">
                    <input type="text" placeholder="昵称">
                </div>
            </div>
        </li>

        <li class="aui-list-item" style="border-bottom: 1px solid #ccc;">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    密码
                </div>
                <div class="aui-list-item-input">
                    <input type="password" placeholder="密码">
                </div>
            </div>
        </li>
    </ul>

    <div class="aui-padded-15">
        <div class="aui-btn aui-btn-info aui-btn-block">注册</div>
        <div class="aui-btn aui-btn-default aui-btn-block" onclick="fnOpenLoginFrame()">已有账号！直接登录</div>
    </div>
</div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript">
    apiready = function(){
        api.addEventListener({
            name: 'keyback'
        }, function (ret, err) {
            alert(2);
        });
    };

    /* 打开注册页面,执行window的fnOpenRegisterFrame方法 */
    function fnOpenLoginFrame() {
        //在名为winName的window中执行jsfun脚本
        api.execScript({
            name: 'login_register',
            script: "fnOpenRegisterFrame(0)"
        });
    }

    /* 选择图片 */
    function fnGetPiture() {
        api.getPicture({
            sourceType: 'library',
            encodingType: 'jpg',
            mediaValue: 'pic',
            destinationType: 'url',
            allowEdit: true,
            quality: 50,
            targetWidth: 100,
            targetHeight: 100,
            saveToPhotoAlbum: false
        }, function(ret, err) {
            /* 获取图片路径 */
            var url=ret.data;
            fnUploadPiture(url);
        })
    }

    function fnUploadPiture(url) {
        var model=api.require("model");
        model.uploadFile({
            report: true,
            data: {
                file: {
                    name: 'tx0.jpg',
                    url: url
                }
            }
        }, function(ret, err){
            if(ret) {
                if(ret.state==0) {
                    var strProgress=ret.progress+"%";
                    api.showProgress({
                        style: 'default',
                        animationType: 'fade',
                        title: '上传中...',
                        text: strProgress,
                        modal: false
                    });
                }else if(ret.state==1) {
                    api.toast({
                        msg: '上传成功'+JSON.stringify(ret),
                        duration: 2000,
                        location: 'bottom'
                    });
                    api.hideProgress();
                }else {
                    api.hideProgress();
                    api.alert({
                        msg: '上传失败，请重新上传'
                    });
                }
            }else {
                api.alert({
                    title: '网络错误',
                    msg: '请重新启动APP'
                });
            }
        });
    }
    
    function fnLogin() {
        var usermail=$api.val(document.getElementById("usermail"));
        var username=$api.val(document.getElementById("username"));
        var password=$api.val(document.getElementById("password"));
        api.showProgress({
            title: '努力加载中...',
            text: '先喝杯茶...',
            modal: true
        });
        var user = api.require("user");
        user.login({
            username: username,
            password: password
        }, function(ret, err){
            if(err) {
                api.hideProgress();
                api.alert({
                    title: '温馨提示',
                    msg: '账号或密码错误'
                });
            }else {
                api.hideProgress();
                $api.setStorage('userId', ret.userId);
                /* 成功之后用Id查询token */
                var model = api.require("model");
                model.findById({
                    class: "user",
                    id: ret.userId
                }, function(ret, err){
                    $api.setStorage('userToken', ret.token);
                    $api.setStorage('username', ret.username);

                    api.alert({
                        title: '温馨提示',
                        msg: '登录成功'
                    }, function (ret, err) {
                        /* 调到首页 */
                        fnOpenSlidLayout();
                    });
                });
            }
        });
    }

    function fnRegister() {
        var username=$api.val(document.getElementById("username"));
        var password=$api.val(document.getElementById("password"));

        api.showProgress({
            title: '努力加载中...',
            text: '先喝杯茶...',
            modal: true
        });

        fnGetToken(username,password,fnIsRegister);
    }

    /* 获取token */
    function fnGetToken(username,password,callback) {
        var now = parseInt(Date.now()/1000);
        var rand=Math.ceil(Math.random()*10000000);
        var aKey="k51hidwqk9iab";   //融云注册申请
        var sKey="dirfMCDi0Ar2";//融云注册申请
        var appKey = SHA1(sKey + "" + rand + "" + now) ;

        api.ajax({
            url: 'http://api.cn.ronghub.com/user/getToken.json',
            method: 'post',
            headers: {
                "App-Key" : aKey,
                "Nonce" : rand,
                "Timestamp" : now,
                "Signature" : appKey,
                "Content-Type" : "application/x-www-form-urlencoded"
            },
            timeout: 30,
            dataType: 'json',
            returnAll: false,
            data: {
                values: {
                    userId: username,
                    name: "1"
                }
            }
        }, function (ret, err) {
            callback?callback(ret,username,password):"";
        })
    }

    /* 判断用户注册 */
    function fnIsRegister(ret,username,password) {
        /* 返回的ret有两种结果："" 或json*/
        if(ret) {
            var model = api.require('model');
            model.insert({
                class: "user",
                value: {
                    "username": username,
                    "password": password,
                    "token": ret.token
                }
            }, function(ret, err){
                /* 判断是否注册过 */
                api.hideProgress();
                if(ret.error) {
                    api.toast({
                        msg: "账号已注册过,请登录",
                        duration: 2000,
                        location: 'bottom'
                    });
                }else {
                    /* 成功之后拿到生成id去融云拿到唯一的token */
                    api.alert({
                        title: '温馨提示',
                        msg: '注册成功，点击登录按钮登录'
                    }, function (ret, err) {

                    });
                }
            });
        }else {
            api.hideProgress();
            api.alert({
                title: '温馨提示',
                msg: "token获取失败"
            });
        }
    }

    function fnOpenSlidLayout() {
        api.openSlidLayout({
            type: 'left',
            fixedPane: {
                name: 'my',
                url: 'widget://html/my.html',
                bgColor: "#fff"
            },
            slidPane: {
                name: 'main',
                url: 'widget://html/main.html'
            }
        }, function(ret, err) {

        });
    }

</script>
</html>